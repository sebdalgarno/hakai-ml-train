# Data Preparation Methods for Semantic Segmentation

This document describes the data preparation pipeline for training semantic segmentation models on aerial/drone orthomosaic imagery.

## Overview

The pipeline converts large georeferenced orthomosaic images and their corresponding label rasters into fixed-size image chips suitable for deep learning model training. The process handles nodata regions, remaps label classes, and optionally filters chips to improve training data quality.

## Input Data Requirements

### Directory Structure

```
raw_data/
├── train/
│   ├── images/
│   │   └── mosaic_001.tif    # RGB/RGBI orthomosaic GeoTIFF
│   └── labels/
│       └── mosaic_001.tif    # Rasterized label mask (same filename)
├── val/
│   ├── images/
│   └── labels/
└── test/
    ├── images/
    └── labels/
```

### Image Raster

- **Format**: GeoTIFF with georeferencing information
- **Bands**: RGB (3-band) or RGBI (4-band, includes near-infrared)
- **Bit depth**: Typically uint8 (0–255) for RGB or uint16 for multispectral
- **Nodata representation**: Pixels with value `(0, 0, 0)` across all bands indicate missing data (e.g., areas outside the mosaic extent or gaps from stitching)

### Label Raster

- **Format**: Single-band GeoTIFF with identical spatial extent, resolution, and CRS as the corresponding image
- **Values**: Integer class indices derived from rasterized polygon annotations
- **Creation**: Typically generated by rasterizing vector polygons (e.g., from manual annotation in GIS software) onto the same grid as the orthomosaic

## Tiling Method

### Sliding Window Approach

Large orthomosaics are divided into smaller, fixed-size chips using a regular grid sampling strategy (sliding window). This approach:

1. Places a window of size `N × N` pixels at the top-left corner of the image
2. Extracts the image and label data within that window
3. Advances the window by a stride of `S` pixels horizontally
4. Repeats until reaching the image boundary, then moves down by stride `S` and continues
5. Discards any chips smaller than the target size (edge chips that don't fit)

### Parameters

| Parameter | Description | Typical Values |
|-----------|-------------|----------------|
| **Size** | Chip dimensions (square) | 224, 512, 1024 pixels |
| **Stride** | Step size between adjacent chips | Equal to size (no overlap) or smaller (overlap) |

### Overlap Considerations

- **Stride = Size**: No overlap between chips. Each pixel appears in exactly one chip. Efficient for training but may miss objects at chip boundaries.
- **Stride < Size**: Overlapping chips. Objects near boundaries appear in multiple chips, providing more training examples and reducing boundary effects. Increases dataset size proportionally.

**Example**: A 10,000 × 10,000 pixel orthomosaic with size=224 and stride=224 produces approximately 1,995 chips (44 × 44 grid, minus edge chips).

## Label Remapping

### Purpose

Raw label rasters often contain class indices that don't directly correspond to the desired training classes. The remapping system transforms original label values to training-appropriate values.

### Mechanism

Remapping uses positional indexing where the position in the list represents the original value and the value at that position represents the new value:

```
--remap [new_0] [new_1] [new_2] [new_3] ...
         ↑       ↑       ↑       ↑
         │       │       │       └── original label 3 becomes this value
         │       │       └────────── original label 2 becomes this value
         │       └────────────────── original label 1 becomes this value
         └────────────────────────── original label 0 becomes this value
```

### Special Values

| Value | Meaning | Effect During Training |
|-------|---------|------------------------|
| `0` | Background class | Contributes to loss; model learns to predict background |
| `> 0` | Target classes | Contributes to loss; model learns to predict these classes |
| `-100` | Ignore | Excluded from loss calculation; model receives no gradient signal |

### Example

Given original labels: 0=water, 1=uncertain, 2=kelp_species_A, 3=kelp_species_B

```
--remap 0 -100 1 2
```

Results in:
- Water (0) → Background (0)
- Uncertain (1) → Ignore (-100)
- Kelp species A (2) → Class 1
- Kelp species B (3) → Class 2

## Nodata Handling

### Definition

**Nodata** refers to pixels in the image raster that contain no valid imagery. These typically occur:

- Outside the irregular boundary of the orthomosaic (corners of the rectangular extent)
- In gaps between flight lines or where image stitching failed
- In areas excluded during orthomosaic generation

### Detection

Nodata pixels are identified as locations where **all image bands equal zero** (i.e., pure black pixels):

```
is_nodata = (R == 0) AND (G == 0) AND (B == 0)
```

### Treatment

1. **Entirely nodata chips**: Chips where all pixels are nodata are discarded during tiling
2. **Partial nodata chips**: For chips containing some nodata pixels, the corresponding label values are set to `0` (background), regardless of the original label raster value. This prevents the model from learning to associate specific classes with nodata regions.

## Background vs. Nodata

These terms describe different concepts:

| Concept | Source | Meaning | Example |
|---------|--------|---------|---------|
| **Background** | Label raster | Valid imagery showing non-target content | Water, sand, rocks without kelp |
| **Nodata** | Image raster | Invalid/missing imagery | Black pixels outside mosaic bounds |

A pixel can be:
- Valid imagery labeled as background (water with no kelp)
- Valid imagery labeled as a target class (water with kelp)
- Nodata (no valid imagery exists)

## Optional Filtering

### Background-Only Chip Removal

Removes chips containing only background (label ≤ 0) and no target classes (label > 0).

**Purpose**: Reduces class imbalance when background dominates the dataset. For marine imagery, the majority of chips may contain only water, which can bias the model toward predicting background.

**Criteria for removal**: `max(labels) ≤ 0`

### Nodata Chip Removal

Removes chips containing any nodata pixels (any pixel where all bands equal zero).

**Purpose**: Ensures training data contains only complete, valid imagery. Particularly important for self-supervised learning methods that reconstruct masked image regions.

**Criteria for removal**: `any(pixel where all bands == 0)`

## Output Format

### File Format

Chips are saved as compressed NumPy archives (`.npz` files) containing:

- `image`: uint8 or uint16 array of shape `(H, W, C)` where C is the number of channels
- `label`: int64 array of shape `(H, W)` containing remapped class indices

### Naming Convention

```
{original_mosaic_name}_{chip_index}.npz
```

Example: `orthomosaic_001_42.npz` is the 42nd chip extracted from `orthomosaic_001.tif`

## Summary

The data preparation pipeline:

1. Tiles large orthomosaics into fixed-size chips using a sliding window
2. Pairs each image chip with its corresponding label chip
3. Remaps label values to training-appropriate class indices
4. Forces nodata pixels to background class (0)
5. Optionally filters chips to remove background-only or nodata-containing samples
6. Saves chips as compressed NumPy archives for efficient loading during training
